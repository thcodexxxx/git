# 株式管理ダッシュボード 仕様書

## 1. 概要
本アプリケーションは、日本株、米国株、および日本の投資信託を一元管理するためのStreamlit製ダッシュボードです。保有銘柄の評価額、損益、および価格推移を可視化し、資産状況を把握することを目的としています。

## 2. システム要件
*   **OS**: Windows, macOS, Linux (Pythonが動作する環境)
*   **言語**: Python 3.x
*   **主要ライブラリ**:
    *   `streamlit`: Webアプリケーションフレームワーク
    *   `yfinance`: 株価データ取得
    *   `pandas`: データ操作
    *   `matplotlib`: チャート描画
    *   `plotly`: インタラクティブなグラフ描画 (ツリーマップ)
    *   `requests`, `beautifulsoup4`: スクレイピング (投資信託データ)

## 3. 機能一覧

### 3.1. ポートフォリオ管理機能
*   **複数ポートフォリオ対応**:
    *   「保有株式」(Main) と「仮想保有株式」(Sub) の2つのポートフォリオを切り替え可能。
*   **データ編集**:
    *   ブラウザ上で直接ポートフォリオデータの追加・編集・削除が可能。
    *   入力項目: 銘柄コード, 銘柄名, 購入日, 保有株数 (または口数), 購入単価。
*   **データ永続化**:
    *   入力データはCSVファイル (`portfolio_main.csv`, `portfolio_sub.csv`) として保存。

### 3.2. データ取得機能
*   **自動判別**:
    *   銘柄コードから資産タイプを自動判別 (日本株: `xxxx.T`, 米国株: アルファベット, 投資信託: その他)。
*   **株価取得**:
    *   日本株・米国株: `yfinance` APIを使用。
    *   投資信託: Yahoo!ファイナンスから基準価額履歴をスクレイピング。
*   **為替レート**:
    *   USD/JPYレートを自動取得し、米国株の評価額を円換算して表示。
*   **キャッシュ機能**:
    *   投資信託のデータは `stock_data_cache/` ディレクトリにCSVとしてキャッシュし、スクレイピング負荷を軽減。
    *   サイドバーからキャッシュの削除・再取得が可能。

### 3.3. 可視化・分析機能
*   **資産サマリー**:
    *   ポートフォリオ全体の評価額、含み損益、損益率をサイドバーに表示。
*   **ヒートマップ**:
    *   Plotly Treemapを使用し、保有銘柄の評価額規模と騰落率 (前日比/トータル損益率) を視覚化。
*   **個別銘柄カード**:
    *   現在値、前日比/前週比、評価額、含み損益を表示。
    *   バッジ機能による直感的な騰落表示 (上昇: 緑, 下落: 赤)。
    *   Matplotlibによる価格推移チャート (取得単価ライン、購入ポイントのプロット付き)。

## 4. ファイル構成
```text
kabu/
├── stock_app.py          # メインアプリケーションコード
├── requirements.txt      # 依存ライブラリ一覧
├── Dockerfile            # コンテナ化設定 (任意)
├── portfolio_main.csv    # 保有株式データ (自動生成/更新)
├── portfolio_sub.csv     # 仮想保有株式データ (自動生成/更新)
└── stock_data_cache/     # 投資信託データキャッシュ (自動生成)
```

## 5. 外部依存サービス
*   **Yahoo! Finance (US)**: `yfinance` 経由でのデータ取得。
*   **Yahoo!ファイナンス (日本)**: 投資信託データのスクレイピング先。

## 6. 注意事項
*   投資信託のデータ取得はスクレイピングを行っているため、対象サイトの構造変更により動作しなくなる可能性があります。
*   スクレイピングには待機時間を設け、サーバーへの負荷を考慮した実装となっています (`scrape_japan_fund_history_params`)。
